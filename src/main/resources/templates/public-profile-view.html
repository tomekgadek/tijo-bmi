<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{base.html :: head}"></head>

<body th:replace="~{base.html :: layout(~{::content})}">
    <div th:fragment="content">
        <div class="page-header">
            <a href="/public/profiles" class="back-link">&larr; Powrót do listy</a>
            <h1 th:text="'Profil: ' + ${profileUser.username}">Profil</h1>
        </div>

        <div class="card">
            <h3
                th:text="${profileUser.firstName != null ? profileUser.firstName + ' ' + (profileUser.lastName != null ? profileUser.lastName : '') : profileUser.username}">
                Imię Nazwisko</h3>

            <div th:if="${profileUser.motivationalQuote != null and profileUser.motivationalQuote != ''}"
                class="profile-detail-quote">
                <p th:text="${'&quot;' + profileUser.motivationalQuote + '&quot;'}"></p>
            </div>

            <div th:if="${profileUser.achievement != null and profileUser.achievement != ''}" class="profile-detail-achievement">
                <strong class="achievement-label">Historia i Cele:</strong>
                <p class="achievement-text" th:text="${profileUser.achievement}"></p>
            </div>

            <div class="pure-g profile-detail-stats">
                <div class="pure-u-1-2">
                    <span class="profile-detail-stat-label">Wzrost:</span>
                    <p class="profile-detail-stat-value"
                        th:text="${profileUser.height != null ? profileUser.height + ' cm' : '-'}"></p>
                </div>
                <div class="pure-u-1-2">
                    <span class="profile-detail-stat-label">Aktualna waga:</span>
                    <p id="stat-weight" class="profile-detail-stat-value"
                        th:text="${stats != null and stats.currentWeight != null ? stats.currentWeight + ' kg' : '-'}">
                    </p>
                </div>
            </div>
            <div class="profile-detail-bmi">
                <span class="profile-detail-stat-label">Aktualne BMI:</span>
                <p class="profile-detail-stat-value">
                    <span id="stat-bmi"
                        th:text="${stats != null and stats.currentBMI != null ? #numbers.formatDecimal(stats.currentBMI, 1, 'POINT', 1, 'POINT') : '-'}"></span>
                    - <span id="stat-category" th:text="${stats != null ? stats.category : ''}"></span>
                </p>
            </div>
        </div>

        <div class="card">
            <h3>Postęp wagi</h3>
            <div class="chart-container">
                <canvas id="publicWeightChart"></canvas>
            </div>
        </div>

        <div class="card" th:if="${weightHistory != null and !weightHistory.empty}">
            <h3>Historia pomiarów</h3>
            <div class="table-container">
                <table class="pure-table pure-table-horizontal table-full">
                    <thead>
                        <tr>
                            <th class="table-header-subtle">Data</th>
                            <th class="table-header-subtle">Waga</th>
                            <th class="table-header-subtle">BMI</th>
                        </tr>
                    </thead>
                    <tbody id="public-history-body">
                        <tr th:each="record : ${weightHistory}" th:data-record-id="${record.id}">
                            <td
                                th:text="${record.recordDate != null ? #temporals.format(record.recordDate, 'dd.MM.yyyy') : '-'}">
                            </td>
                            <td th:text="${record.weight} + ' kg'"></td>
                            <td
                                th:text="${record.calculateBMI() != null ? #numbers.formatDecimal(record.calculateBMI(), 1, 'POINT', 1, 'POINT') : '-'}">
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="pagination-container">
                    <div class="pagination-info">
                        Pomiary <span th:text="${currentPage * pageSize + 1}"></span> -
                        <span
                            th:text="${(currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize}"></span>
                        z <span th:text="${totalItems}"></span>
                    </div>

                    <div class="pagination" th:if="${totalPages > 1}">
                        <a th:href="@{/public/profile/{id}(id=${profileUser.id}, page=${currentPage - 1}, size=${pageSize})}"
                            class="pure-button pagination-button" th:classappend="${currentPage == 0} ? 'pure-button-disabled'">Poprzednia</a>

                        <span class="pagination-text">
                            Strona <span th:text="${currentPage + 1}"></span> z <span th:text="${totalPages}"></span>
                        </span>

                        <a th:href="@{/public/profile/{id}(id=${profileUser.id}, page=${currentPage + 1}, size=${pageSize})}"
                            class="pure-button pagination-button"
                            th:classappend="${currentPage + 1 >= totalPages} ? 'pure-button-disabled'">Następna</a>
                    </div>

                    <div>
                        <form th:action="@{/public/profile/{id}(id=${profileUser.id})}" method="get"
                            class="pagination-form">
                            <label class="pagination-label">Na stronę:</label>
                            <select name="size" onchange="this.form.submit()" class="pagination-select">
                                <option th:value="25" th:selected="${pageSize == 25}">25</option>
                                <option th:value="50" th:selected="${pageSize == 50}">50</option>
                                <option th:value="75" th:selected="${pageSize == 75}">75</option>
                                <option th:value="100" th:selected="${pageSize == 100}">100</option>
                            </select>
                            <input type="hidden" name="page" th:value="0">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            const chartLabels = /*[[${chartLabels}]]*/[];
            const chartData = /*[[${chartData}]]*/[];
            /*]]>*/

            let weightChart = null;

            function initChart() {
                const ctx = document.getElementById('publicWeightChart').getContext('2d');
                const data = {
                    labels: [],
                    datasets: [{
                        label: 'Waga (kg)',
                        data: [],
                        borderColor: '#0984e3',
                        backgroundColor: 'rgba(9, 132, 227, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                };

                if (chartLabels && chartData) {
                    data.labels = chartLabels;
                    data.datasets[0].data = chartData;
                }

                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: false }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            window.onload = function () {
                initChart();
            };
        </script>
    </div>
</body>

</html>
