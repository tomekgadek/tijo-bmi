<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{base.html :: head}"></head>

<body th:replace="~{base.html :: layout(~{::content})}">
    <div th:fragment="content">
        <!-- Profile Completion Alert -->
        <div th:if="${user.height == null or user.firstName == null}" class="card profile-alert">
            <h3>Uzupełnij swój profil</h3>
            <p class="profile-alert-text">Dodaj swój wzrost i imię, abyśmy mogli obliczyć Twoje BMI.</p>
            <button class="pure-button"
                onclick="document.getElementById('profile-edit').scrollIntoView({behavior: 'smooth'})">Uzupełnij
                teraz</button>
        </div>

        <!-- Quick Stats Header -->
        <div class="pure-g">
            <div class="pure-u-1 pure-u-md-1-2">
                <h1 th:text="'Profil: ' + ${user.username}">Cześć</h1>
            </div>
            <div class="pure-u-1 pure-u-md-1-2 profile-status">
                <p class="profile-status-text">Status profilu: <span
                        th:text="${user.isPublic ? 'Publiczny' : 'Prywatny'}" class="profile-status-value"></span></p>
            </div>
        </div>

        <div class="pure-g stats-grid">
            <div class="pure-u-1-2 pure-u-md-1-4 profile-edit-half-right">
                <div class="card stat-card">
                    <span class="stat-label">BMI</span>
                    <div id="stat-bmi" class="stat-value"
                        th:text="${stats != null and stats.currentBMI != null ? #numbers.formatDecimal(stats.currentBMI, 1, 'POINT', 1, 'POINT') : '-'}">
                        -</div>
                    <span id="stat-category" class="stat-category" th:text="${stats != null ? stats.category : ''}"></span>
                </div>
            </div>
            <div class="pure-u-1-2 pure-u-md-1-4 profile-edit-half-left">
                <div class="card stat-card">
                    <span class="stat-label">Waga</span>
                    <div id="stat-weight" class="stat-value"
                        th:text="${weightHistory != null and !weightHistory.empty ? weightHistory[0].weight : '-'}">-
                    </div>
                    <span class="stat-unit">kg</span>
                </div>
            </div>
        </div>

        <!-- Add Weight & Chart -->
        <div class="card">
            <h3>Dodaj nową wagę</h3>
            <form id="weight-form" th:action="@{/profile/addWeight}" method="post" class="pure-form weight-form">
                <div class="weight-form-field">
                    <label class="weight-form-label">Waga (kg)</label>
                    <input type="number" name="weight" id="new-weight" step="0.1" placeholder="np. 75.5" required
                        class="weight-form-input">
                </div>
                <div class="weight-form-field-wide">
                    <label class="weight-form-label">Data</label>
                    <input type="date" name="recordDate" id="new-date"
                        th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required
                        class="weight-form-input">
                </div>
                <button type="submit" class="pure-button pure-button-primary">Dodaj wpis</button>
            </form>
        </div>

        <div class="card">
            <h3>Postęp</h3>
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div th:if="${user.motivationalQuote != null and user.motivationalQuote != ''}" class="card quote-card">
            <p th:text="${'&quot;' + user.motivationalQuote + '&quot;'}"></p>
        </div>

        <!-- History (Collapsible) -->
        <details class="card history-details">
            <summary class="history-summary">Historia pomiarów</summary>
            <div class="history-content">
                <table class="pure-table pure-table-horizontal history-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Waga</th>
                            <th>BMI</th>
                            <th class="history-actions">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr th:each="record : ${weightHistory}" th:data-record-id="${record.id}">
                            <td
                                th:text="${record.recordDate != null ? #temporals.format(record.recordDate, 'dd.MM.yyyy') : '-'}">
                            </td>
                            <td th:text="${record.weight} + ' kg'"></td>
                            <td
                                th:text="${record.calculateBMI() != null ? #numbers.formatDecimal(record.calculateBMI(), 1, 'POINT', 1, 'POINT') : '-'}">
                            </td>
                            <td class="history-actions">
                                <button type="button" class="pure-button history-edit-btn" th:data-weight="${record.weight}"
                                    th:data-date="${#temporals.format(record.recordDate, 'yyyy-MM-dd')}"
                                    onclick="loadRecordForEdit(this)">Edytuj</button>

                                <form th:action="@{/profile/delete-weight/{id}(id=${record.id})}" method="post"
                                    class="history-delete-form"
                                    onsubmit="return confirm('Czy na pewno chcesz usunąć ten wpis?')">
                                    <button type="submit" class="pure-button history-delete-btn">Usuń</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        Pomiary <span th:text="${currentPage * pageSize + 1}"></span> -
                        <span
                            th:text="${(currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize}"></span>
                        z <span th:text="${totalItems}"></span>
                    </div>

                    <div class="pagination" th:if="${totalPages > 1}">
                        <a th:href="@{/profile(page=${currentPage - 1}, size=${pageSize})}" class="pure-button pagination-button"
                            th:classappend="${currentPage == 0} ? 'pure-button-disabled'">Poprzednia</a>

                        <span class="pagination-text">
                            Strona <span th:text="${currentPage + 1}"></span> z <span th:text="${totalPages}"></span>
                        </span>

                        <a th:href="@{/profile(page=${currentPage + 1}, size=${pageSize})}" class="pure-button pagination-button"
                            th:classappend="${currentPage + 1 >= totalPages} ? 'pure-button-disabled'">Następna</a>
                    </div>

                    <div>
                        <form th:action="@{/profile/update-pagination}" method="post" class="pagination-form">
                            <label class="pagination-label">Na stronę:</label>
                            <select name="size" onchange="this.form.submit()" class="pagination-select">
                                <option th:value="25" th:selected="${pageSize == 25}">25</option>
                                <option th:value="50" th:selected="${pageSize == 50}">50</option>
                                <option th:value="75" th:selected="${pageSize == 75}">75</option>
                                <option th:value="100" th:selected="${pageSize == 100}">100</option>
                            </select>
                        </form>
                    </div>
                </div>
        </details>

        <script>
            function loadRecordForEdit(btn) {
                const weight = btn.getAttribute('data-weight');
                const date = btn.getAttribute('data-date');
                document.getElementById('new-weight').value = weight;
                document.getElementById('new-date').value = date;
                document.getElementById('weight-form').scrollIntoView({ behavior: 'smooth' });
            }
        </script>

        <!-- Settings / Profile Edit -->
        <div id="profile-edit" class="card profile-edit-section">
            <h3>Ustawienia profilu</h3>
            <form th:action="@{/profile/update}" method="post" class="pure-form pure-form-stacked">
                <div class="pure-g">
                    <div class="pure-u-1 pure-u-md-1-2 profile-edit-half-right">
                        <label for="firstName">Imię</label>
                        <input type="text" id="firstName" name="firstName" th:value="${user.firstName}">
                    </div>
                    <div class="pure-u-1 pure-u-md-1-2">
                        <label for="lastName">Nazwisko</label>
                        <input type="text" id="lastName" name="lastName" th:value="${user.lastName}">
                    </div>
                    <div class="pure-u-1 pure-u-md-1-2 profile-edit-half-right">
                        <label for="height">Wzrost (cm)</label>
                        <input type="number" id="height" name="height" step="0.1" th:value="${user.height}">
                    </div>
                </div>

                <label for="motivationalQuote">Cytat motywacyjny</label>
                <textarea id="motivationalQuote" name="motivationalQuote" th:text="${user.motivationalQuote}"
                    rows="2"></textarea>

                <label for="achievement">Historia / Cele</label>
                <textarea id="achievement" name="achievement" th:text="${user.achievement}" rows="2"></textarea>

                <label for="isPublic" class="pure-checkbox profile-checkbox-label">
                    <input type="checkbox" id="isPublic" name="isPublic" th:checked="${user.isPublic}"> Publiczny profil
                </label>

                <button type="submit" class="pure-button profile-save-btn">Zapisz profil</button>
            </form>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            const userId = /*[[${user.id}]]*/ 0;
            const chartLabels = /*[[${chartLabels}]]*/[];
            const chartData = /*[[${chartData}]]*/[];
            /*]]>*/
        </script>

        <script>
            let weightChart = null;

            function initChart() {
                const ctx = document.getElementById('weightChart').getContext('2d');
                const data = {
                    labels: [],
                    datasets: [{
                        label: 'Waga (kg)',
                        data: [],
                        borderColor: '#0984e3',
                        backgroundColor: 'rgba(9, 132, 227, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                };

                if (chartLabels && chartData) {
                    chartLabels.forEach((label, index) => {
                        data.labels.push(label);
                        data.datasets[0].data.push(chartData[index]);
                    });
                }

                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: false }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            window.onload = function () {
                initChart();
            };
        </script>
    </div>
</body>

</html>